name: üîç Release Preview

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - '.releaserc.json'
      - 'CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  release-preview:
    name: üîç Preview Release
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.ref != 'main'
    
    steps:
      - name: üõí Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ÔøΩ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: üèóÔ∏è Build project
        run: pnpm run build

      - name: üß™ Run tests
        run: pnpm test

      - name: üîç Preview release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "## üîç Release Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running semantic-release in dry-run mode to preview what would be released..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run semantic-release dry-run and capture output
          pnpm run release:preview > release-preview.log 2>&1 || true
          
          echo "### üìã Release Analysis:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -n 50 release-preview.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Check if there would be a release
          if grep -q "Published release" release-preview.log; then
            echo "‚úÖ **This PR would trigger a release**" >> $GITHUB_STEP_SUMMARY
          elif grep -q "no release" release-preview.log; then
            echo "‚ÑπÔ∏è **This PR would not trigger a release**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Release analysis inconclusive**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üìä Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let previewLog = '';
            try {
              previewLog = fs.readFileSync('release-preview.log', 'utf8');
            } catch (error) {
              previewLog = 'Failed to read release preview log';
            }
            
            const comment = `## üîç Release Preview
            
            This PR has been analyzed for potential release impact:
            
            <details>
            <summary>üìã Click to see full semantic-release analysis</summary>
            
            \`\`\`
            ${previewLog.slice(0, 2000)}${previewLog.length > 2000 ? '\n... (truncated)' : ''}
            \`\`\`
            
            </details>
            
            ${previewLog.includes('Published release') ? '‚úÖ **This PR would trigger a release**' : 
              previewLog.includes('no release') ? '‚ÑπÔ∏è **This PR would not trigger a release**' : 
              '‚ö†Ô∏è **Release analysis inconclusive**'}
              
            ---
            *This preview is automatically generated by semantic-release in dry-run mode*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
